---
title: "Copepod analysis"
author: "Sam Bashevkin"
date: "12/9/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages

```{r}
require(tidyverse)
require(zooper)
require(lubridate)
require(brms)
require(sp)
require(rgdal)
```

# Cluster nearby stations

```{r}
# Clustering distance (m)
d <- 1000

Stations<-stations%>%
  mutate(ID=paste(Source, Station))%>%
  drop_na(Latitude, Longitude)


xy <- SpatialPointsDataFrame(matrix(c(Stations$Longitude, Stations$Latitude), ncol=2), data.frame(ID=Stations$ID),
                               proj4string=CRS("+proj=longlat +datum=NAD83"))

xy <- spTransform(xy, CRS("+init=epsg:3488 +datum=NAD83")) # California Albers CRS

chc <- hclust(dist(data.frame(rownames=rownames(xy@data), x=coordinates(xy)[,1],
              y=coordinates(xy)[,2])), method="complete")

# Compute distance
chc.d40 <- cutree(chc, h=d)

# Join results to meuse sp points
xy@data <- data.frame(xy@data, Clust=chc.d40)

Stations_clust<-Stations%>%
  left_join(xy@data, by="ID")%>%
  group_by(Clust)%>%
  summarise(Latitude = mean(Latitude), Longitude = mean(Longitude), Station = list(ID))

#plot(Stations$Longitude, Stations$Latitude)
#plot(Stations_clust$Longitude, Stations_clust$Latitude)

Stations_final<-Stations_clust%>%
  unnest(Station)
```

#Load zooplankton data

```{r}
PF<-zoopComb%>%
  filter(Taxname=="Pseudodiaptomus forbesi")%>%
  left_join(zoopEnvComb%>%
              select(-Source),
            by="SampleID")%>%
  filter(Year>1995)%>% # Introduced in 1987, give them 8 years to get established
  mutate(Date_num=as.numeric(Date))%>%
  mutate(SalSurf_l = log(SalSurf),
         Julian_day = yday(Date),
         Count=round(CPUE*Volume))%>%
  mutate_at(vars(Date_num, SalSurf, SalSurf_l, Temperature, Latitude, Longitude), list(s=~(.-mean(., na.rm=T))/sd(., na.rm=T)))%>%
  drop_na(Date, SalSurf, Temperature, Latitude, Longitude, CPUE)%>%
  mutate(Station=paste(Source, Station))%>%
  left_join(Stations_final%>%
              select(Clust, Station),
            by="Station")%>%
  rename(Clustered_station=Clust)
```

#Exploratory plots

Salinity
```{r}
ggplot(PF, aes(x=log(SalSurf), y=log(CPUE+1)))+
  geom_point(alpha=0.2)+
  scale_y_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  scale_x_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  facet_wrap(~month(Date))+
  theme_bw()+
  theme(panel.grid=element_blank())
```

Quadratic


Temperature
```{r}
ggplot(PF, aes(x=Temperature, y=log(CPUE+1)))+
  geom_point(alpha=0.2)+
  scale_y_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  scale_x_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  facet_wrap(~month(Date))+
  theme_bw()+
  theme(panel.grid=element_blank())
```

More in warmer temperatures, even controlling for month

Tide
```{r}
ggplot(PF, aes(x=Tide, y=log(CPUE+1)))+
  geom_boxplot()+
  geom_violin()+
  scale_y_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  #scale_x_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  theme_bw()+
  theme(panel.grid=element_blank())
```

Not much here

Secchi
```{r}
ggplot(PF, aes(x=Secchi, y=log(CPUE+1)))+
  geom_point(alpha=0.2)+
  scale_y_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  scale_x_continuous(expand = expand_scale(mult=c(0.01, 0.05)))+
  facet_wrap(~month(Date))+
  theme_bw()+
  theme(panel.grid=element_blank())
```

Unclear

#Model

```{r}
iterations <- 5e3
warmup <- iterations/4

mbase<-brm(CPUE ~ 1, family=hurdle_gamma(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbase<-add_criterion(mbase, c("loo", "waic"))

mbase2<-brm(CPUE ~ 1, family=hurdle_gamma(link="inverse"),
       data=PF,
       prior=prior(normal(0,100), class="Intercept"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)

mbase3<-brm(CPUE ~ 1, family=hurdle_gamma(link="softplus"),
       data=PF,
       prior=prior(normal(0,100), class="Intercept"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)

mbase4<-brm(CPUE ~ 1, family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbase4<-add_criterion(mbase4, c("loo", "waic"))

mbaseST<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)), family=hurdle_gamma(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbaseST<-add_criterion(mbaseST, c("loo", "waic"), reloo = TRUE)

mbase4ST<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbase4ST<-add_criterion(mbase4ST, c("loo", "waic"))

mbaseST.2<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)), family=hurdle_gamma(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sds"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbaseST.2<-add_criterion(mbaseST.2, c("loo", "waic"))

mbase4ST.2<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma")+
         prior(cauchy(0,5), class="sds"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbase4ST.2<-add_criterion(mbase4ST.2, c("loo", "waic"))

mbaseST2<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)) + t2(Julian_day, bs="cc"), family=hurdle_gamma(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
mbaseST2<-add_criterion(mbaseST2, c("loo", "waic"))

mbase4ST2<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)) + t2(Julian_day, bs="cc"), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
mbase4ST2<-add_criterion(mbase4ST2, c("loo", "waic"))

mbase4ST3<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)) + t2(Julian_day, Year, bs=c("cc", "cr")), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
mbase4ST3<-add_criterion(mbase4ST3, c("loo", "waic"))

mbase4ST4<-brm(CPUE ~ t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)) + t2(Julian_day, Year, bs=c("cc", "cr")) + (1|Source), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
#mbase4ST4<-add_criterion(mbase4ST4, c("loo", "waic"))

m.1<-brm(CPUE ~ s(SalSurf_s) + s(Temperature_s) + t2(Latitude_s, Longitude_s, Date_num_s), family=hurdle_gamma(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.9))
m.1<-add_criterion(m.1, c("loo", "waic"))

m4.1.1<-brm(CPUE ~ s(SalSurf_l_s) + s(Temperature_s) + t2(Latitude_s, Longitude_s, Date_num_s)+ t2(Julian_day, bs="cc"), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
m4.1.1<-add_criterion(m4.1.1, c("loo", "waic"))

m4.1.2<-brm(CPUE ~ s(SalSurf_l_s) + s(Temperature_s) + t2(Julian_day, bs="cc"), family=hurdle_lognormal(),
       data=PF, autocor = cor_arma(~Date_num, p = 1, q = 1, cov=TRUE),
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
save.image("~/SDP/CopModels.RData")

m.2<-brm(CPUE ~ poly(SalSurf_l_s, 2) + s(Temperature_s) + t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)), family=hurdle_gamma(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.9))
m.2<-add_criterion(m.2, c("loo", "waic"))

m.3<-brm(CPUE ~ poly(SalSurf_l_s, 2) + s(Temperature_s) + t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)) + t2(Julian_day, bs="cc"), family=hurdle_gamma(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.9))
m.3<-add_criterion(m.3, c("loo", "waic"))

m4.3<-brm(CPUE ~ poly(SalSurf_l_s, 2) + s(Temperature_s) + t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)) + t2(Julian_day, bs="cc"), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
m4.3<-add_criterion(m4.3, c("loo", "waic"), reloo=TRUE)

m4.4<-brm(CPUE ~ poly(SalSurf_l_s, 2) + s(Temperature_s) + t2(Latitude_s, Longitude_s, Date_num_s, d=c(2,1)) + t2(Julian_day, Year, bs=c("cc", "cr")), family=hurdle_lognormal(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept")+
         prior(normal(0,5), class="b")+
         prior(cauchy(0,5), class="sigma"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup, control=list(adapt_delta=0.85))
#m4.4<-add_criterion(m4.4, c("loo", "waic"), reloo=TRUE)
```

Adding normal(0,100) prior to intercept in mbase results in exact same intercept estimate

for mbaseST and mbase4ST, applying a cauchy(0,5) prior to the sds terms does not change the results. The data are too strong


Trying poisson models on counts
```{r}
mbasecount<-brm(Count ~ Volume, family=zero_inflated_poisson(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbasecount<-add_criterion(mbasecount, c("loo", "waic"))

mbasecount2<-brm(Count ~ Volume, family=zero_inflated_negbinomial(),
       data=PF,
       prior=prior(normal(0,10), class="Intercept"),
       chains=1, cores=1,
       iter = iterations, warmup = warmup)
mbasecount2<-add_criterion(mbasecount2, c("loo", "waic"))
```

posterior predictive checks
```{r}
pp <- function(model){
  prop_zero <- function(x) mean(x == 0)
  
  p<-list()
  
  p$zero<-pp_check(model, type="stat", stat=prop_zero)
  
  p$dist<-pp_check(model)+scale_x_log10()
  
  return(p)
}

```
